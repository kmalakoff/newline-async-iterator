{"version":3,"file":"index.mjs","names":["indexOfNewline","decodeUTF8","hasIterator","Symbol","asyncIterator","newlineIterator","source","string","done","sourceIterator","generateNext","Promise","resolve","reject","index","skip","length","next","then","value","undefined","catch","iterator","result","line","substr"],"sources":["../../src/index.ts"],"sourcesContent":["import indexOfNewline from \"index-of-newline\";\nimport decodeUTF8 from \"./decodeUTF8\";\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/**\n * Create a newline iterator recognizing CR, LF, and CRLF using the Symbol.asyncIterator interface\n *\n * @param string The string to iterate through\n *\n * ```typescript\n * import newlineIterator from \"newline-async-iterator\";\n *\n * const iterator = newlineIterator(\"some\\r\\nstring\\ncombination\\r\");\n * const results = [];\n * for (const line of iterator) results.push(line);\n * console.log(results); // [\"some\", \"string\", \"combination\"];\n * ```\n */\n\nexport default function newlineIterator(\n  source: AsyncIterable<Uint8Array> | AsyncIterator<Uint8Array>\n): AsyncIterableIterator<string> {\n  let string = \"\";\n  let done = false;\n\n  /* c8 ignore start */\n  const sourceIterator = hasIterator ? source[Symbol.asyncIterator]() : source;\n  /* c8 ignore stop */\n\n  function generateNext(): Promise<number[]> {\n    return new Promise(function (resolve, reject) {\n      const [index, skip] = indexOfNewline(string, 0, true) as number[];\n      if (index >= 0) {\n        if (index !== string.length - 1 || string[index] === \"\\n\") return resolve([index, skip]);\n      }\n      if (done) return resolve([index, skip]);\n      sourceIterator.next().then(function (next) {\n        if (next.done) done = true;\n        if (next.value !== undefined) string += decodeUTF8(next.value);\n        generateNext().then(resolve).catch(reject);\n      });\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<string, boolean>> {\n      return new Promise(function (resolve, reject) {\n        generateNext()\n          .then(function ([index, skip]) {\n            if (index < 0) {\n              if (!string.length) return resolve({ value: undefined, done: true });\n              const result: IteratorResult<string, boolean> = { value: string, done: false };\n              string = \"\";\n              return resolve(result);\n            }\n            const line = string.substr(0, index);\n            string = string.substr(index + skip);\n            return resolve({ value: line, done: false });\n          })\n          .catch(reject);\n      });\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<string> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<string>;\n}\n"],"mappings":"AAAA,OAAOA,cAAP,MAA2B,kBAA3B;OACOC,U;AAEP,MAAMC,WAAW,GAAG,OAAOC,MAAP,KAAkB,WAAlB,IAAiCA,MAAM,CAACC,aAA5D;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,eAAe,SAASC,eAAT,CACbC,MADa,EAEkB;EAC/B,IAAIC,MAAM,GAAG,EAAb;EACA,IAAIC,IAAI,GAAG,KAAX;EAEA;;EACA,MAAMC,cAAc,GAAGP,WAAW,GAAGI,MAAM,CAACH,MAAM,CAACC,aAAR,CAAN,EAAH,GAAoCE,MAAtE;EACA;;EAEA,SAASI,YAAT,GAA2C;IACzC,OAAO,IAAIC,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;MAC5C,MAAM,CAACC,KAAD,EAAQC,IAAR,IAAgBf,cAAc,CAACO,MAAD,EAAS,CAAT,EAAY,IAAZ,CAApC;;MACA,IAAIO,KAAK,IAAI,CAAb,EAAgB;QACd,IAAIA,KAAK,KAAKP,MAAM,CAACS,MAAP,GAAgB,CAA1B,IAA+BT,MAAM,CAACO,KAAD,CAAN,KAAkB,IAArD,EAA2D,OAAOF,OAAO,CAAC,CAACE,KAAD,EAAQC,IAAR,CAAD,CAAd;MAC5D;;MACD,IAAIP,IAAJ,EAAU,OAAOI,OAAO,CAAC,CAACE,KAAD,EAAQC,IAAR,CAAD,CAAd;MACVN,cAAc,CAACQ,IAAf,GAAsBC,IAAtB,CAA2B,UAAUD,IAAV,EAAgB;QACzC,IAAIA,IAAI,CAACT,IAAT,EAAeA,IAAI,GAAG,IAAP;QACf,IAAIS,IAAI,CAACE,KAAL,KAAeC,SAAnB,EAA8Bb,MAAM,IAAIN,UAAU,CAACgB,IAAI,CAACE,KAAN,CAApB;QAC9BT,YAAY,GAAGQ,IAAf,CAAoBN,OAApB,EAA6BS,KAA7B,CAAmCR,MAAnC;MACD,CAJD;IAKD,CAXM,CAAP;EAYD;;EAED,MAAMS,QAAQ,GAAG;IACfL,IAAI,GAA6C;MAC/C,OAAO,IAAIN,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;QAC5CH,YAAY,GACTQ,IADH,CACQ,UAAU,CAACJ,KAAD,EAAQC,IAAR,CAAV,EAAyB;UAC7B,IAAID,KAAK,GAAG,CAAZ,EAAe;YACb,IAAI,CAACP,MAAM,CAACS,MAAZ,EAAoB,OAAOJ,OAAO,CAAC;cAAEO,KAAK,EAAEC,SAAT;cAAoBZ,IAAI,EAAE;YAA1B,CAAD,CAAd;YACpB,MAAMe,MAAuC,GAAG;cAAEJ,KAAK,EAAEZ,MAAT;cAAiBC,IAAI,EAAE;YAAvB,CAAhD;YACAD,MAAM,GAAG,EAAT;YACA,OAAOK,OAAO,CAACW,MAAD,CAAd;UACD;;UACD,MAAMC,IAAI,GAAGjB,MAAM,CAACkB,MAAP,CAAc,CAAd,EAAiBX,KAAjB,CAAb;UACAP,MAAM,GAAGA,MAAM,CAACkB,MAAP,CAAcX,KAAK,GAAGC,IAAtB,CAAT;UACA,OAAOH,OAAO,CAAC;YAAEO,KAAK,EAAEK,IAAT;YAAehB,IAAI,EAAE;UAArB,CAAD,CAAd;QACD,CAXH,EAYGa,KAZH,CAYSR,MAZT;MAaD,CAdM,CAAP;IAeD;;EAjBc,CAAjB;;EAoBA,IAAIX,WAAJ,EAAiB;IACfoB,QAAQ,CAACnB,MAAM,CAACC,aAAR,CAAR,GAAiC,YAAmC;MAClE,OAAO,IAAP;IACD,CAFD;EAGD;;EAED,OAAOkB,QAAP;AACD"}