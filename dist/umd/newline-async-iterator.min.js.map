{"version":3,"file":"newline-async-iterator.min.js","sources":["../../src/decodeUTF8.ts","../../src/index.ts"],"sourcesContent":["/* eslint-disable no-undef */\n// https://developer.mozilla.org/en-US/docs/Glossary/Base64#Solution_2_%E2%80%93_JavaScript's_UTF-16_%3E_UTF-8_%3E_base64\n/* c8 ignore start */\nlet decodeUTF8 = function decode(uint8Array: Uint8Array): string {\n  let sView = \"\";\n\n  for (let nPart, nLen = uint8Array.length, nIdx = 0; nIdx < nLen; nIdx++) {\n    nPart = uint8Array[nIdx];\n    sView += String.fromCharCode(\n      nPart > 251 && nPart < 254 && nIdx + 5 < nLen /* six bytes */\n        ? /* (nPart - 252 << 30) may be not so safe in ECMAScript! So...: */\n          (nPart - 252) * 1073741824 +\n            ((uint8Array[++nIdx] - 128) << 24) +\n            ((uint8Array[++nIdx] - 128) << 18) +\n            ((uint8Array[++nIdx] - 128) << 12) +\n            ((uint8Array[++nIdx] - 128) << 6) +\n            uint8Array[++nIdx] -\n            128\n        : nPart > 247 && nPart < 252 && nIdx + 4 < nLen /* five bytes */\n        ? ((nPart - 248) << 24) +\n          ((uint8Array[++nIdx] - 128) << 18) +\n          ((uint8Array[++nIdx] - 128) << 12) +\n          ((uint8Array[++nIdx] - 128) << 6) +\n          uint8Array[++nIdx] -\n          128\n        : nPart > 239 && nPart < 248 && nIdx + 3 < nLen /* four bytes */\n        ? ((nPart - 240) << 18) +\n          ((uint8Array[++nIdx] - 128) << 12) +\n          ((uint8Array[++nIdx] - 128) << 6) +\n          uint8Array[++nIdx] -\n          128\n        : nPart > 223 && nPart < 240 && nIdx + 2 < nLen /* three bytes */\n        ? ((nPart - 224) << 12) + ((uint8Array[++nIdx] - 128) << 6) + uint8Array[++nIdx] - 128\n        : nPart > 191 && nPart < 224 && nIdx + 1 < nLen /* two bytes */\n        ? ((nPart - 192) << 6) + uint8Array[++nIdx] - 128\n        : /* nPart < 127 ? */ /* one byte */\n          nPart\n    );\n  }\n\n  return sView;\n};\n/* c8 ignore stop */\n\nif (typeof TextDecoder !== \"undefined\") {\n  const decoder = new TextDecoder(\"utf8\");\n  decodeUTF8 = function decodeTextDecoder(uint8Array: Uint8Array): string {\n    return decoder.decode(uint8Array);\n  };\n}\n\nexport default decodeUTF8;\n","import indexOfNewline from \"index-of-newline\";\nimport decodeUTF8 from \"./decodeUTF8\";\n\n/**\n * Create a newlinw iterator recognizing CR, LF, and CRLF using the Symbol.iterator interface\n *\n * @param string The string to iterate through\n *\n * ```typescript\n * import newlineIterator from \"newline-async-iterator\";\n *\n * const iterator = newlineIterator(\"some\\r\\nstring\\ncombination\\r\");\n * const results = [];\n * for (const line of iterator) results.push(line);\n * console.log(results); // [\"some\", \"string\", \"combination\"];\n * ```\n */\n\nexport default function newlineIterator(iterable: AsyncIterable<Uint8Array>): AsyncIterableIterator<string> {\n  let string = \"\";\n  let done = false;\n  const iterator = iterable[Symbol.asyncIterator]();\n  function generateNext(): Promise<number[]> {\n    return new Promise(function (resolve, reject) {\n      const [index, skip] = indexOfNewline(string, 0, true) as number[];\n      if (index >= 0) {\n        if (index !== string.length - 1 || string[index] === \"\\n\") return resolve([index, skip]);\n      }\n      if (done) return resolve([index, skip]);\n      iterator.next().then(function (next) {\n        if (next.done) done = true;\n        if (next.value !== undefined) string += decodeUTF8(next.value);\n        generateNext().then(resolve).catch(reject);\n      });\n    });\n  }\n\n  return {\n    next(): Promise<IteratorResult<string, boolean>> {\n      return new Promise(function (resolve, reject) {\n        generateNext()\n          .then(function ([index, skip]) {\n            if (index < 0) {\n              if (!string.length) return resolve({ value: undefined, done: true });\n              const result: IteratorResult<string, boolean> = { value: string, done: false };\n              string = \"\";\n              return resolve(result);\n            }\n            const line = string.substr(0, index);\n            string = string.substr(index + skip);\n            return resolve({ value: line, done: false });\n          })\n          .catch(reject);\n      });\n    },\n    [Symbol.asyncIterator](): AsyncIterator<string> {\n      return this;\n    },\n  } as AsyncIterableIterator<string>;\n}\n"],"names":["decodeUTF8","uint8Array","nPart","sView","nLen","length","nIdx","String","fromCharCode","TextDecoder","decoder","decode","iterable","string","done","iterator","Symbol","asyncIterator","generateNext","Promise","resolve","reject","indexOfNewline","index","skip","next","then","undefined","value","result","line","substr","this"],"mappings":"y1CAGA,IAAIA,EAAa,SAAgBC,WAGtBC,EAFLC,EAAQ,GAEIC,EAAOH,EAAWI,OAAQC,EAAO,EAAGA,EAAOF,EAAME,IAC/DJ,EAAQD,EAAWK,GACnBH,GAASI,OAAOC,aACdN,EAAQ,KAAOA,EAAQ,KAAOI,EAAO,EAAIF,EAErB,YAAfF,EAAQ,MACLD,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,GAC/BL,IAAaK,GACb,IACFJ,EAAQ,KAAOA,EAAQ,KAAOI,EAAO,EAAIF,GACvCF,EAAQ,KAAQ,KAChBD,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,GAC/BL,IAAaK,GACb,IACAJ,EAAQ,KAAOA,EAAQ,KAAOI,EAAO,EAAIF,GACvCF,EAAQ,KAAQ,KAChBD,IAAaK,GAAQ,KAAQ,KAC7BL,IAAaK,GAAQ,KAAQ,GAC/BL,IAAaK,GACb,IACAJ,EAAQ,KAAOA,EAAQ,KAAOI,EAAO,EAAIF,GACvCF,EAAQ,KAAQ,KAAQD,IAAaK,GAAQ,KAAQ,GAAKL,IAAaK,GAAQ,IACjFJ,EAAQ,KAAOA,EAAQ,KAAOI,EAAO,EAAIF,GACvCF,EAAQ,KAAQ,GAAKD,IAAaK,GAAQ,IAE5CJ,UAIDC,GAIT,GAA2B,oBAAhBM,YAA6B,KAChCC,EAAU,IAAID,YAAY,QAChCT,EAAa,SAA2BC,UAC/BS,EAAQC,OAAOV,UAIXD,SCjCA,SAAyBY,aAClCC,EAAS,GACTC,GAAO,EACLC,EAAWH,EAASI,OAAOC,0BACxBC,WACA,IAAIC,SAAQ,SAAUC,EAASC,WACdC,UAAeT,EAAQ,GAAG,MAAzCU,OAAOC,cACVD,GAAS,IACPA,IAAUV,EAAOR,OAAS,GAAuB,OAAlBQ,EAAOU,KAExCT,EAFgEM,EAAQ,CAACG,EAAOC,SAGpFT,EAASU,OAAOC,MAAK,SAAUD,GACzBA,EAAKX,OAAMA,GAAO,QACHa,IAAfF,EAAKG,QAAqBf,GAAUb,EAAWyB,EAAKG,QACxDV,IAAeQ,KAAKN,SAAeC,mBAMvCI,uBACS,IAAIN,SAAQ,SAAUC,EAASC,GACpCH,IACGQ,MAAK,yBAAWH,OAAOC,UAClBD,EAAQ,EAAG,KACRV,EAAOR,OAAQ,OAAOe,EAAQ,CAAEQ,WAAOD,EAAWb,MAAM,QACvDe,EAA0C,CAAED,MAAOf,EAAQC,MAAM,UACvED,EAAS,GACFO,EAAQS,OAEXC,EAAOjB,EAAOkB,OAAO,EAAGR,UAC9BV,EAASA,EAAOkB,OAAOR,EAAQC,GACxBJ,EAAQ,CAAEQ,MAAOE,EAAMhB,MAAM,aAE/BO,UAGZL,OAAOC,kCACCe"}