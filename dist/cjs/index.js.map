{"version":3,"file":"index.js","names":["hasIterator","Symbol","asyncIterator","newlineIterator","source","string","done","sourceIterator","generateNext","Promise","resolve","reject","indexOfNewline","index","skip","length","next","then","value","undefined","decodeUTF8","iterator","result","line","substr"],"sources":["../../src/index.ts"],"sourcesContent":["import indexOfNewline from \"index-of-newline\";\nimport decodeUTF8 from \"./decodeUTF8\";\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/**\n * Create a newline iterator recognizing CR, LF, and CRLF using the Symbol.asyncIterator interface\n *\n * @param string The string to iterate through\n *\n * ```typescript\n * import newlineIterator from \"newline-async-iterator\";\n *\n * const iterator = newlineIterator(\"some\\r\\nstring\\ncombination\\r\");\n * const results = [];\n * for (const line of iterator) results.push(line);\n * console.log(results); // [\"some\", \"string\", \"combination\"];\n * ```\n */\n\nexport default function newlineIterator(\n  source: AsyncIterable<Uint8Array> | AsyncIterator<Uint8Array>\n): AsyncIterableIterator<string> {\n  let string = \"\";\n  let done = false;\n\n  /* c8 ignore start */\n  const sourceIterator = hasIterator ? source[Symbol.asyncIterator]() : source;\n  /* c8 ignore stop */\n\n  function generateNext(): Promise<number[]> {\n    return new Promise(function (resolve, reject) {\n      const [index, skip] = indexOfNewline(string, 0, true) as number[];\n      if (index >= 0) {\n        if (index !== string.length - 1 || string[index] === \"\\n\") return resolve([index, skip]);\n      }\n      if (done) return resolve([index, skip]);\n      sourceIterator.next().then(function (next) {\n        if (next.done) done = true;\n        if (next.value !== undefined) string += decodeUTF8(next.value);\n        generateNext().then(resolve).catch(reject);\n      });\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<string, boolean>> {\n      return new Promise(function (resolve, reject) {\n        generateNext()\n          .then(function ([index, skip]) {\n            if (index < 0) {\n              if (!string.length) return resolve({ value: undefined, done: true });\n              const result: IteratorResult<string, boolean> = { value: string, done: false };\n              string = \"\";\n              return resolve(result);\n            }\n            const line = string.substr(0, index);\n            string = string.substr(index + skip);\n            return resolve({ value: line, done: false });\n          })\n          .catch(reject);\n      });\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<string> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<string>;\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;;;;;;;;;;;;;AAEA,IAAMA,WAAW,GAAG,OAAOC,MAAP,KAAkB,WAAlB,IAAiCA,MAAM,CAACC,aAA5D;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEe,SAASC,eAAT,CACbC,MADa,EAEkB;EAC/B,IAAIC,MAAM,GAAG,EAAb;EACA,IAAIC,IAAI,GAAG,KAAX;EAEA;;EACA,IAAMC,cAAc,GAAGP,WAAW,GAAGI,MAAM,CAACH,MAAM,CAACC,aAAR,CAAN,EAAH,GAAoCE,MAAtE;EACA;;EAEA,SAASI,YAAT,GAA2C;IACzC,OAAO,IAAIC,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;MAC5C,WAAsB,IAAAC,0BAAA,EAAeP,MAAf,EAAuB,CAAvB,EAA0B,IAA1B,CAAtB;MAAA;MAAA,IAAOQ,KAAP;MAAA,IAAcC,IAAd;;MACA,IAAID,KAAK,IAAI,CAAb,EAAgB;QACd,IAAIA,KAAK,KAAKR,MAAM,CAACU,MAAP,GAAgB,CAA1B,IAA+BV,MAAM,CAACQ,KAAD,CAAN,KAAkB,IAArD,EAA2D,OAAOH,OAAO,CAAC,CAACG,KAAD,EAAQC,IAAR,CAAD,CAAd;MAC5D;;MACD,IAAIR,IAAJ,EAAU,OAAOI,OAAO,CAAC,CAACG,KAAD,EAAQC,IAAR,CAAD,CAAd;MACVP,cAAc,CAACS,IAAf,GAAsBC,IAAtB,CAA2B,UAAUD,IAAV,EAAgB;QACzC,IAAIA,IAAI,CAACV,IAAT,EAAeA,IAAI,GAAG,IAAP;QACf,IAAIU,IAAI,CAACE,KAAL,KAAeC,SAAnB,EAA8Bd,MAAM,IAAI,IAAAe,qBAAA,EAAWJ,IAAI,CAACE,KAAhB,CAAV;QAC9BV,YAAY,GAAGS,IAAf,CAAoBP,OAApB,WAAmCC,MAAnC;MACD,CAJD;IAKD,CAXM,CAAP;EAYD;;EAED,IAAMU,QAAQ,GAAG;IACfL,IADe,kBACkC;MAC/C,OAAO,IAAIP,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;QAC5CH,YAAY,GACTS,IADH,CACQ,iBAAyB;UAAA;UAAA,IAAdJ,KAAc;UAAA,IAAPC,IAAO;;UAC7B,IAAID,KAAK,GAAG,CAAZ,EAAe;YACb,IAAI,CAACR,MAAM,CAACU,MAAZ,EAAoB,OAAOL,OAAO,CAAC;cAAEQ,KAAK,EAAEC,SAAT;cAAoBb,IAAI,EAAE;YAA1B,CAAD,CAAd;YACpB,IAAMgB,MAAuC,GAAG;cAAEJ,KAAK,EAAEb,MAAT;cAAiBC,IAAI,EAAE;YAAvB,CAAhD;YACAD,MAAM,GAAG,EAAT;YACA,OAAOK,OAAO,CAACY,MAAD,CAAd;UACD;;UACD,IAAMC,IAAI,GAAGlB,MAAM,CAACmB,MAAP,CAAc,CAAd,EAAiBX,KAAjB,CAAb;UACAR,MAAM,GAAGA,MAAM,CAACmB,MAAP,CAAcX,KAAK,GAAGC,IAAtB,CAAT;UACA,OAAOJ,OAAO,CAAC;YAAEQ,KAAK,EAAEK,IAAT;YAAejB,IAAI,EAAE;UAArB,CAAD,CAAd;QACD,CAXH,WAYSK,MAZT;MAaD,CAdM,CAAP;IAeD;EAjBc,CAAjB;;EAoBA,IAAIX,WAAJ,EAAiB;IACfqB,QAAQ,CAACpB,MAAM,CAACC,aAAR,CAAR,GAAiC,YAAmC;MAClE,OAAO,IAAP;IACD,CAFD;EAGD;;EAED,OAAOmB,QAAP;AACD"}